# /sector-battle

특정 섹터 내에서 투자자 페르소나들이 각자 최선의 종목을 선택하고, **토너먼트 형식**으로 1:1 데스매치를 펼쳐 최종 승자를 가리는 배틀 워크플로우.

## 사용법

```
/sector-battle "AI 데이터센터"
/sector-battle "우주 산업"
/sector-battle "비트코인 채굴"
```

## 핵심 원칙

1. **컨텍스트 격리**: 각 페르소나는 반드시 독립 Agent로 실행
2. **동적 페르소나**: `.claude/personas/stocks/*.md`를 자동 스캔 (frameworks/ 제외)
3. **토너먼트 구조**: 종목별 예선 → 본선 → 결승
4. **데스매치**: 확신도 변화가 있을 때까지 또는 최대 5턴까지 싸움

## 저장 경로

```
reports/battles/[섹터-슬러그]/[YYYY-MM-DD_HH-MM-SS]/
├── 0_config.md           # 배틀 설정 + 대진표
├── 1_picks.md            # 1라운드: 전체 선택
├── 2_preliminary/        # 2라운드: 종목별 예선
│   ├── [종목]_match1.md
│   ├── [종목]_match2.md
│   └── [종목]_final.md
├── 3_semifinal/          # 3라운드: 4강
│   ├── match1.md
│   └── match2.md
├── 4_final.md            # 4라운드: 결승
└── 5_summary.md          # 최종 결과
```

---

## 실행 프로세스

### 0단계: 초기화

1. 섹터명을 슬러그로 변환 (예: "AI 데이터센터" → "ai-datacenter")
2. 타임스탬프 생성 (YYYY-MM-DD_HH-MM-SS)
3. `.claude/personas/stocks/*.md` 스캔하여 참가 페르소나 목록 생성
4. 저장 디렉토리 생성
5. `0_config.md` 작성

---

### 1라운드: 선택 (N개 Agent 병렬)

**각 페르소나가 섹터 내 최선의 종목 1개 선택**

**Agent 태스크:**
```
당신은 [페르소나명]입니다.
[페르소나 정의 내용]

---

"[섹터명]" 섹터에서 당신의 투자 철학에 가장 부합하는 종목을 **1개만** 선택하세요.

### 출력 형식 (JSON)
{
  "persona": "[페르소나명]",
  "pick": "[티커]" 또는 "PASS",
  "conviction": 1-10,
  "thesis": "선택 이유 (3-5문장)",
  "key_metrics": ["핵심 지표 1", "핵심 지표 2", "핵심 지표 3"],
  "risks": ["리스크 1", "리스크 2"]
}
```

**출력**: `1_picks.md`

**1라운드 후 대진표 생성:**
- 같은 종목 선택자 → 예선 그룹 구성
- 단독 선택자 → 본선 직행

---

### 2라운드: 종목별 예선 (데스매치)

**같은 종목을 선택한 페르소나끼리 대표 1명 선출**

예시: IREN 선택자 4명인 경우
```
[IREN 예선 토너먼트]
         ┌───────────┐
         │  대표결정  │
         └─────┬─────┘
       ┌───────┴───────┐
   ┌───┴───┐       ┌───┴───┐
   │예선-1 │       │예선-2 │
   └───┬───┘       └───┬───┘
     ┌─┴─┐           ┌─┴─┐
    A     B         C     D
```

**시드 배정**: 확신도 높은 순 (같으면 알파벳순)

**단독 선택자**: 예선 면제, 본선 직행

---

### 3라운드: 본선 4강 (데스매치)

**각 종목 대표끼리 1:1 토너먼트**

```
[본선 4강]
         ┌───────────┐
         │   결승    │
         └─────┬─────┘
       ┌───────┴───────┐
   ┌───┴───┐       ┌───┴───┐
   │ 4강-1 │       │ 4강-2 │
   └───┬───┘       └───┬───┘
   종목A         종목B         종목C         종목D
   대표          대표          대표          대표
```

**4강 매칭 기준:**
- 1시드(가장 높은 확신도 종목 대표) vs 4시드
- 2시드 vs 3시드

---

### 4라운드: 결승 (데스매치)

4강 승자끼리 최종 결승전

---

## 데스매치 규칙

### 진행 방식 (최대 5턴)

```
턴 1: A 공격 → B 반론 + 확신도 재평가
턴 2: B 공격 → A 반론 + 확신도 재평가
턴 3: A 공격 → B 반론 + 확신도 재평가
턴 4: B 공격 → A 반론 + 확신도 재평가
턴 5: A 공격 → B 반론 + 확신도 재평가 (최종)
```

### 확신도 변화 기준

| 상황 | 변화 |
|------|------|
| 핵심 thesis 전제가 무력화됨 | **-2** |
| 데이터로 반박당함 | **-1** |
| 답변 못하는 질문 받음 | **-1** |
| 상대 논거를 수용함 | **-1** |
| 상대가 내 논거를 인정함 | **+1** |

### 승패 결정

1. **KO**: 한쪽 확신도 3 이하 = 항복
2. **판정승**: 5턴 후 확신도 높은 쪽 승리
3. **시드 어드밴티지**: 동점 시 원래 확신도 높은 쪽 승리

### 종료 조건

- 한쪽 확신도 ≤ 3 (KO)
- 5턴 완료 (판정)
- 한쪽이 스스로 승복 선언

---

## 데스매치 Agent 태스크

### 공격 턴

```
당신은 [페르소나명]입니다.
[페르소나 정의 내용]

---

## 데스매치 상황
- 상대: [상대 페르소나명]
- 상대 선택: [상대 종목]
- 상대 확신도: [X/10]
- 상대 thesis: [상대 핵심 논거]

- 나의 선택: [내 종목]
- 나의 확신도: [Y/10]

## 이전 턴 기록
[이전 공격/반론 내용]

---

## 태스크: 공격

상대의 선택을 당신의 투자 철학으로 공격하세요.

### 출력 형식 (JSON)
{
  "persona": "[페르소나명]",
  "turn": [턴 번호],
  "action": "attack",
  "target": "[상대 페르소나]",
  "attack_point": "공격 논점 (1문장)",
  "argument": "구체적 공격 (3-5문장, 수치/근거 포함)",
  "question": "상대가 답해야 하는 질문",
  "predicted_weakness": "이 공격이 유효하면 상대 확신도 얼마나 떨어질지"
}
```

### 반론 턴

```
당신은 [페르소나명]입니다.
[페르소나 정의 내용]

---

## 데스매치 상황
- 상대: [상대 페르소나명]
- 상대 선택: [상대 종목]
- 상대 확신도: [X/10]

- 나의 선택: [내 종목]
- 나의 현재 확신도: [Y/10]

## 방금 받은 공격
[공격 내용]

## 답해야 하는 질문
[상대 질문]

---

## 태스크: 반론 + 확신도 재평가

공격에 반박하고, 솔직하게 확신도를 재평가하세요.

### 출력 형식 (JSON)
{
  "persona": "[페르소나명]",
  "turn": [턴 번호],
  "action": "rebuttal",
  "original_conviction": [이전 확신도],
  "rebuttal": "반박 내용 (3-5문장)",
  "answer_to_question": "질문에 대한 답변",
  "concession": "인정할 부분 (있다면)",
  "conviction_change": {
    "change": [변화량, 예: -1, 0, +1],
    "reason": "변화 이유"
  },
  "new_conviction": [새 확신도],
  "surrender": true/false,
  "surrender_reason": "항복 시 이유 (확신도 3 이하 또는 자발적)"
}
```

---

## 경기 결과 기록 형식

각 데스매치 결과는 다음 형식으로 기록:

```markdown
# [라운드명]: [A] vs [B]

## 대진 정보
| 항목 | [A] | [B] |
|------|-----|-----|
| 종목 | [종목] | [종목] |
| 시작 확신도 | X/10 | Y/10 |
| 최종 확신도 | X'/10 | Y'/10 |
| 결과 | 승/패 | 패/승 |

## 턴별 기록

### 턴 1
**[A] 공격**: ...
**[B] 반론**: ...
**확신도 변화**: A: X→X, B: Y→Y'

### 턴 2
...

## 결과
**승자**: [승자] ([KO/판정/시드])
**핵심 승부처**: [어떤 논점에서 승부가 갈렸는지]
```

---

## 최종 결과 형식 (5_summary.md)

```markdown
# Sector Battle 결과: [섹터명]

## 🏆 최종 승자
**[페르소나명]** - **[종목]**

### 토너먼트 경로
예선: [A] def. [B], [C], [D]
4강: [A] def. [E]
결승: [A] def. [F]

### 최종 확신도: X/10

## 토너먼트 브라켓

[전체 대진표 시각화]

## 명경기 하이라이트

### 결승: [A] vs [B]
[결승전 요약]

### 4강: [C] vs [D]
[명경기 요약]

## 각 종목별 최종 평가

| 종목 | 대표 | 최고 라운드 | 핵심 강점 | 치명적 약점 |
|------|------|------------|----------|------------|
| ... | ... | ... | ... | ... |

## 투자 시사점

[배틀에서 얻은 인사이트]
```

---

## Agent 호출 요약

```
0단계: 초기화                    - 0 Agent
1라운드: 선택                    - N Agents (병렬)
2라운드: 종목별 예선 (데스매치)   - 가변 (종목당 최대 5턴 × 매치수)
3라운드: 4강 (데스매치)          - 최대 20 Agents (2매치 × 5턴 × 2)
4라운드: 결승 (데스매치)         - 최대 10 Agents (1매치 × 5턴 × 2)
5단계: 집계                      - 1 Agent
```

## 주의사항

1. **컨텍스트 격리 필수**: 각 Agent는 새로 생성. resume 금지.
2. **턴 단위 실행**: 데스매치는 공격→반론 순서로 순차 실행
3. **조기 종료**: 확신도 3 이하 시 즉시 해당 매치 종료
4. **JSON 파싱**: 각 턴 출력은 JSON으로 받아 다음 턴 입력으로 전달
5. **확신도 추적**: 매 턴 확신도 변화를 정확히 기록
